---
title: "Biomedical Data Science (BDS) Workshop 1: \n Basic R operations, tidyverse"
format: html
engine: knitr
filters:
  - webr
webr:
  packages: ['dplyr', 'tidyr', 'tidyverse']
---

```{webr-r}
#| context: setup
# Load hoffman toy data
download.file("https://raw.githubusercontent.com/rich2355/Biomedical_Data_Science_Club_Materials/main/data/df.csv", "test_data.csv")
df <- read.csv("test_data.csv")

download.file("https://raw.githubusercontent.com/rich2355/Biomedical_Data_Science_Club_Materials/main/data/df_longi.csv", "test_data_2.csv")
df_longi <- read.csv("test_data_2.csv")

download.file("https://raw.githubusercontent.com/rich2355/Biomedical_Data_Science_Club_Materials/main/data/sim_data.csv", "sim_data.csv")
sim_data <- read.csv("sim_data.csv")
```

# Credits

Credited to Richard Liu and Emily Zhang from the Biomedical Data Science (BDS) club in NYU Langone Health. 

# References

- [CMU Statistics 36-350: Statistical Computing](https://www.stat.cmu.edu/~ryantibs/statcomp/) Lecture 1-3

# Disclaimer

The datasets provided here are all synthetically generated for demonstration and educational purposes only. It does not represent real patient data and should not be used for clinical decision-making, medical research, or policy development. Any resemblance to real persons, conditions, or outcomes is purely coincidental. The values and relationships were generated using statistical simulation techniques and do not reflect actual medical situations.

# Basic R Operations 

## Math Operators 

`+`, `-`, `*`, `/`, `^`, `%%`

```{webr-r}
7 + 5
```

```{webr-r}
7 ^ 5
```

```{webr-r}
12 / 5
```

```{webr-r}
12 %% 5
```

## Comparison Operators 

`>`, `<`, `>=`, `<=`, `==`, `!=`

```{webr-r}
7 > 5
!7
```

```{webr-r}
head(df)
```

## Logical Operators 

`&`, `|`

```{webr-r}
(5 > 7) & (6 * 7 == 42)
(5 > 7) | (6 * 7 == 42)
(5 > 7) | (6 * 7 == 42) & (5 > 7) | (6 * 7 == 42)
```
::: {.callout-note}
Operators have their own rankings. `&` is ranked higher than `|`.
:::

::: {.callout-caution collapse="true"}
## Practice 1
Identify the boolean value of the following expression:

`(5 < 7) | (6 * 7 == 42) & (5 < 7) & (6 * 7 != 42)`

```{webr-r}
# You can check it here, but please first think for a while...
```

To avoid confusion, what would be a better way to write this script?
:::

## Vectors 

```{webr-r}
x = c(7, 8, 10, 45)
x
length(x)
```

```{webr-r}
# Recycling, vectorize
x + c(-7, -8)
x > 9
```

```{webr-r}
# Indexing
x[3]
x[3:5]
x[c(2, 4)]
x[-3]
x[-1]
```

```{webr-r}
places = which(x > 9)
places
x[places]
```

::: {.callout-caution collapse="true"}
## Practice 2

Create a vector `y`, write code to obtain `z` such that $y = \max(z, 0)$, where $\max(\cdot)$ is defined element-wise.

```{webr-r}
# Code

```

Any subtle issue?
:::

## Matrix

```{webr-r}
z.mat = matrix(c(40,1,60,3), nrow=2)
z.mat
```

```{webr-r}
z.mat[2,2]
z.mat[,2]
z.mat[1,]
```

```{webr-r}
# Summary result of a matrix
rowSums(z.mat)
colSums(z.mat)
rowMeans(z.mat)
colMeans(z.mat)
diag(z.mat)
```

```{webr-r}
four.sevens = matrix(rep(7,4), ncol=2)
four.sevens
```

```{webr-r}
z.mat * four.sevens

# Matrix Multiplication
z.mat %*% four.sevens
```

## Data frames 

I asked GPT how to create a data frame, and it tells me I can do this:

```{webr-r}
# Create vectors
id <- 1:5
name <- c("Alice", "Bob", "Charlie", "Diana", "Ethan")
age <- c(25, 30, 35, 28, 40)
treatment <- c("Control", "Treatment", "Treatment", "Control", "Treatment")

# Combine into a data frame
data <- data.frame(
  ID = id,
  Name = name,
  Age = age,
  Treatment = treatment
)

data
```

```{webr-r}
data$ID
data[1,]
```

## Control Flow

```{webr-r}
x = 0.5

if (x >= 0) {
  x
} else {
  -x
}
```

```{webr-r}
x = -2

if (x^2 < 1) {
  x^2 
} else if (x >= 1) {
  2*x-1
} else {
 -2*x+1
}
```

::: {.callout-caution collapse="true"}
## Practice 3

Write code to display the following if-else logic: If a patient's `age` is between 26 and 35 (left inclusive, same after), then he/she is "young"; if a patient's `age` is between 36 and 50, then he/she is "middle aged"; if a patient's `age` is older than 50, then he/she is "old". 

```{webr-r}
# Code

```

Is this a good encoding? 
:::

## Iteration

```{webr-r}
log.vec = vector(length=5, mode="numeric")
for (i in 1:5) {
  log.vec[i] = log(i)
}
log.vec
```

```{webr-r}
i = 1
log.vec = c()
while (log(i) <= 2) {
  log.vec = c(log.vec, log(i))
  i = i+1
}
log.vec
```

::: {.callout-note}
What is `while(TRUE)`?
:::

::: {.callout-caution collapse="true"}
## Practice 4

Write code to calculate $\sum_{x = 1}^5 x^2$. Please come up with two different approaches.

```{webr-r}
# Code

```

```{webr-r}
# Code

```

Which one is better?
:::

## Data Frame Basics

```{webr-r}
df
head(df)
```

```{webr-r}
df$Age
df[,"Age"]
df[,c("Age", "Sex")]
df[1,]
```

```{webr-r}
df2 <- df
df2$Test <- rep(1, nrow(df))
colnames(df2)
df2
```

```{webr-r}
df[df$Age > 50,]
```

::: {.callout-caution collapse="true"}
## Practice 5
In the dataset `df`,

1. subset all white patients, how many?

```{webr-r}
# Code
```
2. subset all patients taking the treatment (instead of taking the control).

```{webr-r}
# Code
```

:::

```{webr-r}
# Read the data using readr package.
```

# Tidyverse Family

Before you started, make sure you installed and imported all necessary packages

```{webr-r}
# Don't run on the web, run it in the R script/R markdown
#install.packages("dplyr")
#install.packages("tidyr")
#install.packages("readr")
#install.packages("tidyverse")
#library(dplyr)
#library(tidyr)
#library(readr)
#library(tidyverse)
```

## `filter`

```{webr-r}
df %>% filter(Baseline_eGFR > 60)
df %>% filter(Baseline_eGFR > 60 & Sex == "Female")
```

::: {.callout-caution collapse="true"}
## Practice 6
In the dataset `df`, use tidyverse grammar,

1. subset all white patients, how many?

```{webr-r}
# Code
```
2. subset all patients taking the treatment (instead of taking the control).

```{webr-r}
# Code
```

:::

## `select`

```{webr-r}
df %>% select(Age)
df %>% select(Age, Race)
df %>% select(Trt)
```

::: {.callout-caution collapse="true"}
## Practice 7
Assume that you have a dataset with thousands of columns (which is often the case!), and you want to select the information related to `Treatment`, how to do that? 

```{webr-r}
# Code
# For me, I choose to ask GPT.
```

:::

## `pull`

```{webr-r}
df %>% pull(Treatment)
# Try this? df %>% pull(Treatment, Treatment)
```

::: {.callout-caution collapse="true"}
## Practice 8
Find the race components of `df`. Hint: `table()`

```{webr-r}
# Code
```

:::

## `mutate`, `case_when`

```{webr-r}
df2 <- df %>% mutate(Creatinine_Albuminuria = Creatinine + Albuminuria)
df2
```

```{webr-r}
df2 <- df %>% mutate(Baseline_eGFR = Baseline_eGFR - 10)
df2
```

```{webr-r}
df2 <- df %>% mutate(Sex_Index = case_when(Sex == "Female" ~ 1, Sex == "Male" ~ 2))
df2
```

::: {.callout-caution collapse="true"}
## Practice 9
Your PI wants to see the **level** of eGFR for each patient, instead of a number. Please change the corresponding column based on the follows: PI thinks

- it is good if $eGFR > 90$
- it is acceptable if $60 < eGFR <= 90$
- it is bad if otherwise

```{webr-r}
# Code
```

:::

## `group_by` related summarizations

```{webr-r}
df %>% group_by(Sex) %>% summarise(mean_eGFR = mean(Baseline_eGFR))
df %>% group_by(Sex) %>% count(Treatment)
```

::: {.callout-caution collapse="true"}
## Practice 10
National Institute of Health (NIH) requires an annual-renewed cumulative patient report grouping by some basic demographics. Try to provide such summary information to the NIH grouping by `Age`, `Sex` and `Race`, with `Age` changed to nominal levels by the following rules: old if $Age >= 60$, young if $Age <= 30$, middle_age if otherwise. 

```{webr-r}
# Code
```

:::

## `drop_na`

```{webr-r}
df_longi %>% drop_na()
df_longi %>% drop_na(Creatinine_A)
```

::: {.callout-note}
Always be cautious if you want to remove any row with missing values.
:::


## `arrange`

This will be useful when you want to **order** the data. For example, when you have a *date* for each patient.

```{webr-r}
head(df_longi)
View(df_longi %>% arrange(Date_A))
```

::: {.callout-note}
Is there any problem in the code patch above? 
:::

::: {.callout-caution collapse="true"}
## Practice 11
1. Create a new dataset `df_long`, which is a long-format of `df_longi`. In a long-format, each row corresponds to one measurement, instead of one patient. Hint: `rbind() / bind_rows()`

```{webr-r}
df_long <- dplyr::bind_rows(
  df_longi %>% dplyr::select(ID, Date = Date_A, Creatinine = Creatinine_A),
  df_longi %>% dplyr::select(ID, Date = Date_B, Creatinine = Creatinine_B),
  df_longi %>% dplyr::select(ID, Date = Date_C, Creatinine = Creatinine_C),
  df_longi %>% dplyr::select(ID, Date = Date_D, Creatinine = Creatinine_D),
  df_longi %>% dplyr::select(ID, Date = Date_E, Creatinine = Creatinine_E)
)
```

2. After that, use `arrange`, so that for each patient, their observation is ordered by date. 

```{webr-r}
df_long <- df_long %>% arrange(Date)
```

You can try using GPT here (and in any practice problem) to see whether GPT has a better solution.
:::

## `pivot_wider`, `pivot_longer`

Try using GPT to self-learn these two functions. 

## What we learned?

```{webr-r}
# Put a dictionary here?
```

## Data example using tidyverse

Quesiton of interest: Are current smokers at higher risk of experiencing a CHD event compared to never-smokers, and how does this relationship vary by sex?
```{webr-r}
sim <- sim_data
head(sim)
```

Check missing values
```{webr-r}
sim %>%
  summarise(
    missing_bmi = sum(is.na(bmi)),
    missing_cholesterol = sum(is.na(cholesterol)),
    missing_hdl = sum(is.na(hdl)),
    missing_triglycerides = sum(is.na(triglycerides))
  )
```

Detect negative values or extreme values
```{webr-r}
sim %>% filter(bmi < 0)
sim %>% filter(cholesterol >= 300)
```

Count participants by sex and race
```{webr-r}
sim %>% group_by(sex, race) %>% summarise(n = n())
```

CHD events
```{webr-r}
sim %>% summarise(total_chd = sum(chd_event == 1, na.rm = TRUE))
```

CHD events by sex
```{webr-r}
sim %>% group_by(sex) %>% summarise(chd = sum(chd_event == 1, na.rm = TRUE))
```

Count CHD events by smoking status and sex
```{webr-r}
sim %>% 
  group_by(smoking, sex) %>%
  summarise(
    n = n(),
    chd_events = sum(chd_event == 1, na.rm = TRUE),
    event_rate = mean(chd_event == 1, na.rm = TRUE)
  ) %>%
  arrange(sex, smoking)
```

Create a binary variable for current smoker vs never
```{webr-r}
sim <- sim %>%
  mutate(current_smoker = case_when(
    smoking == "Current" ~ 1,
    smoking == "Never" ~ 0,
    TRUE ~ NA_real_
  ))

sim$current_smoker
```

Summarize risk by sex
```{webr-r}
sim %>%
  filter(!is.na(current_smoker)) %>%
  group_by(sex) %>%
  summarise(
    n_smokers = sum(current_smoker == 1),
    n_non_smokers = sum(current_smoker == 0),
    event_rate_smokers = mean(chd_event[current_smoker == 1], na.rm = TRUE),
    event_rate_non_smokers = mean(chd_event[current_smoker == 0], na.rm = TRUE)
  )
```

Compute the risk difference
```{webr-r}
sim %>%
  filter(!is.na(current_smoker)) %>%
  group_by(sex) %>%
  summarise(
    risk_diff = mean(chd_event[current_smoker == 1], na.rm = TRUE) - 
      mean(chd_event[current_smoker == 0], na.rm = TRUE)
  )
```




<!-- set.seed(42)

# Sample size
n <- 500

# Treatment assignment (0 = control, 1 = treated)
treatment <- rbinom(n, 1, 0.5)

# Demographics
age <- round(rnorm(n, mean = 60, sd = 12))  # Age in years
sex <- sample(c("Male", "Female"), size = n, replace = TRUE)
race <- sample(c("White", "Black", "Asian", "Hispanic", "Other"),
               size = n, replace = TRUE,
               prob = c(0.5, 0.2, 0.15, 0.1, 0.05))

# Kidney measures
baseline_egfr <- rnorm(n, mean = 90 - 5*treatment, sd = 15)
creatinine <- rnorm(n, mean = 1.0 + 0.2*treatment, sd = 0.3)
albuminuria <- rgamma(n, shape = 2, scale = 50 + 20*treatment)

# Outcome (kidney disease progression)
logit_p <- -2 + 0.8*creatinine - 0.02*baseline_egfr - 0.5*treatment
p_outcome <- 1 / (1 + exp(-logit_p))
progression <- rbinom(n, 1, p_outcome)

# Combine into data frame
df <- data.frame(
  Age = age,
  Sex = sex,
  Race = race,
  Treatment = treatment,
  Baseline_eGFR = baseline_egfr,
  Creatinine = creatinine,
  Albuminuria = albuminuria,
  Progression = progression
)
-->
<!--
set.seed(123)

# Number of patients
n <- 500

# Baseline demographics
id <- 1:n
age <- round(rnorm(n, mean = 60, sd = 12))
sex <- sample(c("Male", "Female"), n, replace = TRUE)
race <- sample(c("White", "Black", "Asian", "Hispanic", "Other"),
               n, replace = TRUE, prob = c(0.5, 0.2, 0.15, 0.1, 0.05))

# Consent to join the trial
consent <- rbinom(n, 1, 0.9)  # 90% consent

# Substudy participation (only for those who consented)
subA <- ifelse(consent == 1, rbinom(n, 1, 0.6), 0)
subB <- ifelse(consent == 1, rbinom(n, 1, 0.5), 0)
subC <- ifelse(consent == 1, rbinom(n, 1, 0.4), 0)
subD <- ifelse(consent == 1, rbinom(n, 1, 0.3), 0)
subE <- ifelse(consent == 1, rbinom(n, 1, 0.2), 0)

# Function to simulate creatinine (mg/dL) and dates
simulate_measurements <- function(participation, mean_creat = 1.0, sd_creat = 0.3) {
  creat <- ifelse(participation == 1, rnorm(n, mean_creat, sd_creat), NA)
  date <- ifelse(participation == 1,
                 as.character(sample(seq.Date(as.Date("2023-01-01"),
                                              as.Date("2023-12-31"), by="day"), n, replace = TRUE)),
                 NA)
  return(list(creatinine = creat, date = date))
}

# Generate creatinine + dates for each substudy
A <- simulate_measurements(subA)
B <- simulate_measurements(subB)
C <- simulate_measurements(subC)
D <- simulate_measurements(subD)
E <- simulate_measurements(subE)

# Build data frame
df_longi <- data.frame(
  ID = id,
  Age = age,
  Sex = sex,
  Race = race,
  Consent = consent,
  Substudy_A = subA,
  Creatinine_A = A$creatinine,
  Date_A = A$date,
  Substudy_B = subB,
  Creatinine_B = B$creatinine,
  Date_B = B$date,
  Substudy_C = subC,
  Creatinine_C = C$creatinine,
  Date_C = C$date,
  Substudy_D = subD,
  Creatinine_D = D$creatinine,
  Date_D = D$date,
  Substudy_E = subE,
  Creatinine_E = E$creatinine,
  Date_E = E$date
)
-->