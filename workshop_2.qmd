---
title: "Biomedical Data Science (BDS) Workshop 2: \n Data Visualization in R"
format: html
engine: knitr
filters:
  - webr
webr:
  packages: ['dplyr', 'tidyr', 'tidyverse']
---
  
```{webr-r}
#| context: setup
# Load hoffman toy data
download.file("https://raw.githubusercontent.com/rich2355/Biomedical_Data_Science_Club_Materials/main/data/sim_data.csv", "sim_data.csv")
sim_data <- read.csv("sim_data.csv")
```


# Credits

Credited to Richard Liu and Emily Zhang from the Biomedical Data Science (BDS) club in NYU Langone Health. 


# Disclaimer

The datasets provided here are all synthetically generated for demonstration and educational purposes only. It does not represent real patient data and should not be used for clinical decision-making, medical research, or policy development. Any resemblance to real persons, conditions, or outcomes is purely coincidental. The values and relationships were generated using statistical simulation techniques and do not reflect actual medical situations.

# Reference

Google and ChatGPT

# Visualizations using functions in base R

## Univariate Visualization

A straightforward way to describe the distribution of a continuous variable is histogram
```{webr-r}
hist(sim_data$age_baseline, main = "Distribution of Age", xlab = "Age",
     col = "skyblue", border = "white")
```

We can add more descriptive statistics to the plot
```{webr-r}
hist(sim_data$age_baseline, main = "Distribution of Age", xlab = "Age",
     col = "skyblue", border = "white")
mean_age <- mean(sim_data$age_baseline)
abline(v = mean_age, col = "red", lwd = 2, lty = 2)
mtext(paste0("Mean = ", round(mean_age, 1)), side = 3, col = "red")
```


```{webr-r}
boxplot(sim_data$bmi, main = "Distribution of BMI", ylab = "BMI",
        col = "lightgreen")
```
```{webr-r}
plot(density(sim_data$sbp), main = "Density of Systolic BP",
     xlab = "SBP", col = "red", lwd = 2)
```

```{webr-r}
barplot(table(sim_data$race), col = "lightblue", main = "Participants by race")
```

```{webr-r}
pie(table(sim_data$physical_activity), main = "Physical Activity Distribution")
```

::: {.callout-caution collapse="true"}
## Practice 1
Histogram of bmi with a line at the mean.
```{webr-r}
# Code
```
:::

::: {.callout-caution collapse="true"}
## Practice 2
Boxplot of cholesterol with light yellow color.
```{webr-r}
# Code
```
:::

::: {.callout-caution collapse="true"}
## Practice 3
Density plot of dbp with vertical line at the median.
```{webr-r}
# Code
```
:::

## Bivariate visualizations - 2 numerical variables
```{webr-r}
plot(sim_data$sbp, sim_data$dbp,
     main = "SBP vs DBP",
     xlab = "Systolic BP", ylab = "Diastolic BP",
     pch = 19, col = rgb(0,0,1,0.4))
```

```{webr-r}
plot(sim_data$sbp, sim_data$dbp,
     main = "SBP vs DBP",
     xlab = "Systolic BP", ylab = "Diastolic BP",
     pch = 19, col = rgb(0,0,1,0.4))

# What happens if I remove above plot() and directly add the line on the plot from previous chunk?
fit <- lm(dbp ~ sbp, data = sim_data)
abline(fit, col = "red", lwd = 2) 

# Extract R²
r2 <- summary(fit)$r.squared
# Add R² as text in the plot
legend("topright", legend = paste("R² =", round(r2, 5)), 
       bty = "n", text.col = "red", cex = 1.2)
```
## Bivariate visualizations - numerical + categorical variables
```{webr-r}
boxplot(bmi ~ sex, data = sim_data,
        main = "BMI by Sex", ylab = "BMI",
        col = c("pink", "lightblue"))
```

## Bivariate visualizations - categorical + categorical

```{webr-r}
tab <- table(sim_data$sex, sim_data$smoking)
barplot(tab, beside = FALSE, col = c("pink", "lightblue"),
        main = "Smoking Status by Sex", legend.text = TRUE)
```

::: {.callout-caution collapse="true"}
## Practice 4
Scatterplot of bmi vs cholesterol colored by sex, with legend on the top left corner
```{webr-r}
# Code
```
:::

## Multivariate visualizations
```{webr-r}
pairs(~ age_baseline + sbp + dbp + bmi + cholesterol, data = sim_data,
      main = "Pairs Plot of Key Variables")
```

# Pairs plot with correlations
Note that GPT wrote this code. There is a simpler way to do it by ``library(GGally)`` and using function ``ggpairs``. 

Here is just an example without using additional library.
```{webr-r}
panel.cor <- function(x, y, digits = 2, prefix = "R = ", cex.cor, ...) {
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- cor(x, y, use = "complete.obs")
  txt <- paste0(prefix, formatC(r, digits = digits))
  text(0.5, 0.5, txt, cex = 1.2)
}

pairs(~ age_baseline + sbp + dbp + bmi + cholesterol, data = sim_data,
      main = "Pairs Plot of Key Variables",
      lower.panel = panel.smooth,
      upper.panel = panel.cor)
```



## Align Multiple Plots (Side-by-Side Layouts)

```{webr-r}
par(mfrow = c(1, 2)) # 1 row, 2 columns
hist(sim_data$age_baseline, col = "skyblue", main = "Age Distribution", xlab = "Age")
boxplot(sim_data$bmi, col = "lightgreen", main = "BMI Distribution", ylab = "BMI")
par(mfrow = c(1, 1)) # reset layout
```


::: {.callout-caution collapse="true"}
## Practice 5
Arrange histograms of age_baseline and cholesterol side by side.
```{webr-r}
# Code
```
:::

## Saving images
First, we want to check and change current directory to the exact folder you want your plots to be located at
```{webr-r}
getwd()
#setwd() # setwd("/Users/yourname/Documents/BDS_Workshop2/plots")
```


Open a PNG device and recreate the plot between ``png()`` and ``dev.off()``


```{webr-r}
# png("SBP_vs_DBP_plot.png", width = 800, height = 600)
# 
# plot(sim_data$sbp, sim_data$dbp,
# main = "SBP vs DBP",
# xlab = "Systolic BP",
# ylab = "Diastolic BP",
# pch = 19, col = rgb(0,0,1,0.4))
# 
# dev.off()
```

::: {.callout-caution collapse="true"}
## Practice 6
Some medical journals require JPEG as the submission format with square-shaped. Please save the same plot
```{webr-r}
# Code
```

:::

If I want to save and reload my plot
```{webr-r}
# plot(sim_data$sbp, sim_data$dbp,
#      main = "SBP vs DBP",
#      xlab = "Systolic BP",
#      ylab = "Diastolic BP",
#      pch = 19,
#      col = rgb(0, 0, 1, 0.4))
# 
# # record the plot
# p <- recordPlot()
# 
# # save it as an RDS object
# saveRDS(p, "my_plot.rds")
# 
# p_loaded <- readRDS("my_plot.rds")
# replayPlot(p_loaded)
```

# Introduction to ggplot


## Step 1 – create a blank ggplot object
Start with ``ggplot()`` and ``aes()`` to define what variables you're plotting and load in the data. This serves as a base for any plot with ``ggplot()``
```{webr-r}
p <- ggplot(data = sim_data, aes(x = age_baseline, y = sbp))
p
```

## Step 2 – add geometric layers
Add ``geom_point()`` to display data as dots (a scatterplot).
```{webr-r}
p <- p + geom_point()
p
```

## Step 3 – add categorical color and transparency
Map color to a categorical variable.
The alpha parameter in ggplot2 controls transparency of plot elements (points, lines, bars, etc.).
alpha = 1 means solid color and 
alpha = 0 means transparent.
```{webr-r}
# We need to revert the changes from step 2 in order to update geom_point()
p <- ggplot(data = sim_data, aes(x = age_baseline, y = sbp))
p <- p + geom_point(aes(color = factor(diabetes)), alpha = 0.5)
p
```

## Step 4 – add a smooth trend line
Use ``geom_smooth()`` to see the overall relationship. 
```{webr-r}
p <- p + geom_smooth(method = "lm", se = FALSE)
p
```

::: {.callout-caution collapse="true"}
## Practice 7
What does ``se`` parameter represent here? Try ``se = TRUE`` and interpret.
```{webr-r}
# Code
```
:::
## Step 5 – add titles and axis labels
Use ``labs()`` to name your plot and axes.
```{webr-r}
p <- p +
labs(title = "Relationship Between Age and SBP",
     subtitle = "Using simulated ARIC data",
     x = "Age at Baseline (years)",
     y = "Systolic Blood Pressure (mmHg)"
)
p
```

::: {.callout-caution collapse="true"}
## Practice 8
Did you notice the message above colored in red? The plot is using the Y ~ X linear relationship because we set  ``geom_smooth(method = "lm")``. Can you try LOESS smoothing (Locally Estimated Scatterplot Smoothing) by setting the ``method`` to ``loess``? 

Also, there is a parameter called ``span``. This controls how much of the data is used to fit each local curve segment in the LOESS algorithm.
```{webr-r}


```
:::

## Step 6 – change the theme
Themes control the overall appearance of the plot.
```{webr-r}
p <- p + theme_minimal()
p
```


## Step 7 – change color styling
Manually choose colors for diabetes groups.
```{webr-r}
p <- p + scale_color_manual(values = c("0" = "#0072B2", "1" = "#D55E00"),
                            name = "Diabetes",
                            labels = c("No", "Yes"))
p
```


## Step 8 – add a histogram (new variable)
Now we’ll make a new plot but continue the same workflow.
```{webr-r}
h <- ggplot(sim_data, aes(x = bmi)) +
  geom_histogram(bins = 50, fill = "skyblue", color = "white")
h
```

## Step 9 – add density overlay to the histogram

Add a smoothed density curve on top of the histogram.
```{webr-r}
h <- h + geom_density(aes(y = ..count..), color = "darkblue", linewidth = 1) # aes(y = ..count..) is needed here (by default it is density).
h
```

Note that ``y = ..count..`` refers to the count of observations in each bin. Here’s an alternative example if you want to show density plots instead of a histogram. 

Some additional references based on Google:
Density plot is a graph that uses probability density to illustrate where data points are concentrated and where they are sparse. 

Note that the Y-axis IS NOT A PROBABILITY of the corresponding X value (instead it has a 0 probability of X taking a single value - can you think of why?). 

Here we show the density plot using ``aes(y = ..density..)`` (by default). 
```{webr-r}
ggplot(sim_data, aes(x = bmi)) +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "skyblue", color = "white") +
  geom_density(color = "darkblue", linewidth = 1)
```

## Step 10 - add grouping to the density
Separate BMI distributions by diabetes status.
You do not have to fill the color manually though, we could label the fill from the start. However, we cannot control which color corresponds to which category.
```{webr-r}
h <- ggplot(sim_data, aes(x = bmi, fill = factor(diabetes))) +
geom_density(alpha = 0.4) +
labs(
title = "BMI Distribution by Diabetes Status",
x = "BMI (kg/m²)",
y = "Density",
fill = "Diabetes"
) 
h
```

## Step 11 – create a barplot for a new categorical variable

Show the proportion of diabetes by physical activity.
```{webr-r}
b <- ggplot(sim_data, aes(x = physical_activity, fill = factor(diabetes))) +
geom_bar(position = "fill") +
scale_y_continuous(labels = scales::percent)
b
```

## Step 12 – add boxplot for continuous outcome by group

Compare HDL distributions by diabetes status.

```{webr-r}

bx <- ggplot(sim_data, aes(x = factor(diabetes), y = hdl, fill = factor(diabetes))) +
geom_boxplot(alpha = 0.6) +
labs(title = "Distribution of HDL by Diabetes Status",
     x = "Diabetes", y = "HDL (mg/dL)") +
theme_minimal()
bx
```

## Step 13 – add facet for subgroup comparison

Split BMI–SBP relationship by sex using ``facet_wrap()``.

```{webr-r}
f <- ggplot(sim_data, aes(x = bmi, y = sbp)) +
geom_point(alpha = 0.5) +
facet_wrap(~ sex) +
theme_minimal()
f
```

## Step 14 – save your final plot

Save the final version to a PNG file.

```{webr-r}
# ggsave("plot_histogram.png", h, width = 7, height = 5, dpi = 300)
# ggsave("plot_barplot.png", b, width = 7, height = 5, dpi = 300)
# ggsave("plot_boxplot.png", bx, width = 7, height = 5, dpi = 300)
# ggsave("plot_faceted.png", f, width = 7, height = 5, dpi = 300)
```

Note that if you want to combine plots into a single layout, use the [`patchwork`](https://patchwork.data-imaginist.com/) package to combine plots.